<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-CA">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Working with large tables • cansim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Working with large tables">
<meta property="og:description" content="Very large StatCan tables can pose challenges for memory footprint and performace. We show how to overcome these challenges by accessing the data through an SQLite database connection.
">
<meta property="og:image" content="https://mountainmath.github.io/cansim/logo.png">
<meta property="og:image:alt" content="cansim">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@vb_jens">
<meta name="twitter:site" content="https://mountainmath.github.io/cansim/">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-107390160-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-107390160-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cansim</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.4.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/cansim.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/listing_cansim_tables.html">Listing Statistics Canada data tables</a>
    </li>
    <li>
      <a href="../articles/partial_table_data_download.html">Partial table data download</a>
    </li>
    <li>
      <a href="../articles/retrieving_cansim_vectors.html">Retrieving individual Statistics Canada vectors</a>
    </li>
    <li>
      <a href="../articles/working_with_hierarchies.html">Working with Statistics Canada data table object hierarchies</a>
    </li>
    <li>
      <a href="../articles/working_with_large_tables.html">Working with large tables</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    News

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Releases</li>
    <li>
      <a href="https://github.com/mountainMath/cansim/releases/tag/v0.3.8" class="external-link">Version 0.3.8</a>
    </li>
    <li>
      <a href="https://github.com/mountainMath/cansim/releases/tag/v0.3.7" class="external-link">Version 0.3.7</a>
    </li>
    <li>
      <a href="https://github.com/mountainMath/cansim/releases/tag/0.3.6" class="external-link">Version 0.3.6</a>
    </li>
    <li>
      <a href="https://github.com/mountainMath/cansim/releases/tag/0.3.5" class="external-link">Version 0.3.5</a>
    </li>
    <li>
      <a href="https://github.com/mountainMath/cansim/releases/tag/0.3.4" class="external-link">Version 0.3.4</a>
    </li>
    <li>
      <a href="https://github.com/mountainMath/cansim/releases/tag/0.3.2" class="external-link">Version 0.3.2</a>
    </li>
    <li>
      <a href="https://github.com/mountainMath/cansim/releases/tag/0.3.1" class="external-link">Version 0.3.1</a>
    </li>
    <li>
      <a href="https://github.com/mountainMath/cansim/releases/tag/0.3" class="external-link">Version 0.3</a>
    </li>
    <li>
      <a href="https://github.com/mountainMath/cansim/releases/tag/0.2.2" class="external-link">Version 0.2.2</a>
    </li>
    <li class="divider">
    </li>
<li>
      <a href="../news/index.html">Changelog</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mountainMath/cansim/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Working with large tables</h1>
                        <h4 data-toc-skip class="author"></h4>
            
            <h4 data-toc-skip class="date">2025-05-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mountainMath/cansim/blob/HEAD/vignettes/working_with_large_tables.Rmd" class="external-link"><code>vignettes/working_with_large_tables.Rmd</code></a></small>
      <div class="hidden name"><code>working_with_large_tables.Rmd</code></div>

    </div>

    
    
<p>Most StatCan tables are small in size and can easily processed in
memory. However, some tables are so large that this is not a feasible
strategy. Table <code>43-10-0024</code> is one such example and comes
with a CSV file that is several gigabytes in size. In cases like this it
is more useful to store and access the data as a parquet, feather, or
SQLite database format using the <code>get_cansim_connection</code>
function instead of the usual <code>get_cansim</code>. In these
circumstances it is also useful to cache the data for longer than just
the current R session, and the <code>data_cache</code> option allows to
specify a permanent location. It defaults to
<code>getOption("cansim.cache_path")</code>, and if this option is not
set it will only cache the data for the duration of the current
session.</p>
<p>For this vignette we use the (rather small) motor vehicle sales data
as an example.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mountainMath/cansim" class="external-link">cansim</a></span><span class="op">)</span></span></code></pre></div>
<p>One main difference to the <code>get_cansim</code> method is that
<code>get_cansim_connection</code> does not return data but only a
connection to the database. This allows us to filter the data before
fetching the data into memory. The package supports three formats with
different advantages and disadvantages:</p>
<ul>
<li>
<code>parquet</code>: This is the most efficient format for
importing and storing data, but a bit slower when filtering and reading
data.</li>
<li>
<code>feather</code>: This is a somewhat less efficient format for
importing and storing data, but slightly faster than <em>parquet</em>
when filtering and reading data.</li>
<li>
<code>sqlite</code>: This is fairly inefficient format for importing
and storing data, taking a lot more disk space, time and a little more
memory when importing and indexing, but after importing it allows for
very efficient queries and filtering, and additionally allows for
database level summary statistics.</li>
</ul>
<p>By default <code>get_cansim_connection</code> uses the
<em>parquet</em> data format as the best all-around solution, but in use
cases of infrequently updating tables with lots of database queries in
the meantime that need to be fast, and possibly the need for database
level statistics, the <em>sqlite</em> format is likely preferable.</p>
<p>When accessing cached data the package automatically checks if newer
versions are available and issues a warning if the cached version is out
of date. The <code>auto_update</code> argument can be set to
<code>TRUE</code> to automatically refresh the table if needed, or this
can be done manually by setting the <code>refresh</code> argument to
<code>TRUE</code> when calling the function to force a refresh.</p>
<div class="section level2">
<h2 id="working-with-cached-tables">Working with cached tables<a class="anchor" aria-label="anchor" href="#working-with-cached-tables"></a>
</h2>
<p>If data is not cached the function will download the data first and
convert it to the speficied format. The package is designed so that the
differences in database formats are mostly abstracted away.</p>
<div class="panel-tabset nav-pills">
<div class="section level3 active">
<h3 class="active" id="parquet">parquet<a class="anchor" aria-label="anchor" href="#parquet"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connection.parquet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_cansim_connection.html">get_cansim_connection</a></span><span class="op">(</span><span class="st">"20-10-0001"</span><span class="op">)</span> <span class="co"># format='parquet' is the default</span></span>
<span><span class="co">#&gt; Accessing CANSIM NDM product 20-10-0001 from Statistics Canada</span></span>
<span><span class="co">#&gt; Parsing data to parquet.</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">connection.parquet</span><span class="op">)</span></span>
<span><span class="co">#&gt; FileSystemDataset with 1 Parquet file</span></span>
<span><span class="co">#&gt; 163,410 rows x 19 columns</span></span>
<span><span class="co">#&gt; $ REF_DATE                <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "1946-01", "1946-01", "1946-01", "1946-01", "…</span></span>
<span><span class="co">#&gt; $ GEO                     <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "Canada", "Canada", "Canada", "Canada", "Cana…</span></span>
<span><span class="co">#&gt; $ DGUID                   <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "2016A000011124", "2016A000011124", "2016A000…</span></span>
<span><span class="co">#&gt; $ `Vehicle type`          <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "Total, new motor vehicles", "Total, new moto…</span></span>
<span><span class="co">#&gt; $ `Origin of manufacture` <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "Total, country of manufacture", "Total, coun…</span></span>
<span><span class="co">#&gt; $ Sales                   <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "Units", "Dollars", "Units", "Units", "Dollar…</span></span>
<span><span class="co">#&gt; $ `Seasonal adjustment`   <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "Unadjusted", "Unadjusted", "Unadjusted", "Se…</span></span>
<span><span class="co">#&gt; $ UOM                     <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "Units", "Dollars", "Units", "Units", "Dollar…</span></span>
<span><span class="co">#&gt; $ UOM_ID                  <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "300", "81", "300", "300", "81", "300", "300"…</span></span>
<span><span class="co">#&gt; $ SCALAR_FACTOR           <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "units", "thousands", "units", "units", "thou…</span></span>
<span><span class="co">#&gt; $ SCALAR_ID               <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "0", "3", "0", "0", "3", "0", "0", "3", "0", …</span></span>
<span><span class="co">#&gt; $ VECTOR                  <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "v42169911", "v42169913", "v42169920", "v4216…</span></span>
<span><span class="co">#&gt; $ COORDINATE              <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "1.1.1.1.1", "1.1.1.2.1", "1.2.1.1.1", "1.2.1…</span></span>
<span><span class="co">#&gt; $ VALUE                   <span style="color: #949494; font-style: italic;">&lt;double&gt;</span> 2756, 4507, 1102, 1468, 1604, 1654, 2037, 290…</span></span>
<span><span class="co">#&gt; $ STATUS                  <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">N</span>…</span></span>
<span><span class="co">#&gt; $ SYMBOL                  <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">N</span>…</span></span>
<span><span class="co">#&gt; $ TERMINATED              <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, "t", <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, "t", <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>,…</span></span>
<span><span class="co">#&gt; $ DECIMALS                <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "0", "0", "0", "0", "0", "0", "0", "0", "0", …</span></span>
<span><span class="co">#&gt; $ GeoUID                  <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "11124", "11124", "11124", "11124", "11124", …</span></span>
<span><span class="co">#&gt; Call `print()` for full schema details</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="feather">feather<a class="anchor" aria-label="anchor" href="#feather"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connection.feather</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_cansim_connection.html">get_cansim_connection</a></span><span class="op">(</span><span class="st">"20-10-0001"</span>, format<span class="op">=</span><span class="st">'feather'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Accessing CANSIM NDM product 20-10-0001 from Statistics Canada</span></span>
<span><span class="co">#&gt; Parsing data to feather.</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">connection.feather</span><span class="op">)</span></span>
<span><span class="co">#&gt; FileSystemDataset with 1 Feather file</span></span>
<span><span class="co">#&gt; 163,410 rows x 19 columns</span></span>
<span><span class="co">#&gt; $ REF_DATE                <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "1946-01", "1946-01", "1946-01", "1946-01", "…</span></span>
<span><span class="co">#&gt; $ GEO                     <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "Canada", "Canada", "Canada", "Canada", "Cana…</span></span>
<span><span class="co">#&gt; $ DGUID                   <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "2016A000011124", "2016A000011124", "2016A000…</span></span>
<span><span class="co">#&gt; $ `Vehicle type`          <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "Total, new motor vehicles", "Total, new moto…</span></span>
<span><span class="co">#&gt; $ `Origin of manufacture` <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "Total, country of manufacture", "Total, coun…</span></span>
<span><span class="co">#&gt; $ Sales                   <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "Units", "Dollars", "Units", "Units", "Dollar…</span></span>
<span><span class="co">#&gt; $ `Seasonal adjustment`   <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "Unadjusted", "Unadjusted", "Unadjusted", "Se…</span></span>
<span><span class="co">#&gt; $ UOM                     <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "Units", "Dollars", "Units", "Units", "Dollar…</span></span>
<span><span class="co">#&gt; $ UOM_ID                  <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "300", "81", "300", "300", "81", "300", "300"…</span></span>
<span><span class="co">#&gt; $ SCALAR_FACTOR           <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "units", "thousands", "units", "units", "thou…</span></span>
<span><span class="co">#&gt; $ SCALAR_ID               <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "0", "3", "0", "0", "3", "0", "0", "3", "0", …</span></span>
<span><span class="co">#&gt; $ VECTOR                  <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "v42169911", "v42169913", "v42169920", "v4216…</span></span>
<span><span class="co">#&gt; $ COORDINATE              <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "1.1.1.1.1", "1.1.1.2.1", "1.2.1.1.1", "1.2.1…</span></span>
<span><span class="co">#&gt; $ VALUE                   <span style="color: #949494; font-style: italic;">&lt;double&gt;</span> 2756, 4507, 1102, 1468, 1604, 1654, 2037, 290…</span></span>
<span><span class="co">#&gt; $ STATUS                  <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">N</span>…</span></span>
<span><span class="co">#&gt; $ SYMBOL                  <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">N</span>…</span></span>
<span><span class="co">#&gt; $ TERMINATED              <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, "t", <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, "t", <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>,…</span></span>
<span><span class="co">#&gt; $ DECIMALS                <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "0", "0", "0", "0", "0", "0", "0", "0", "0", …</span></span>
<span><span class="co">#&gt; $ GeoUID                  <span style="color: #949494; font-style: italic;">&lt;string&gt;</span> "11124", "11124", "11124", "11124", "11124", …</span></span>
<span><span class="co">#&gt; Call `print()` for full schema details</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sqlite">sqlite<a class="anchor" aria-label="anchor" href="#sqlite"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connection.sqlite</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_cansim_connection.html">get_cansim_connection</a></span><span class="op">(</span><span class="st">"20-10-0001"</span>, format<span class="op">=</span><span class="st">'sqlite'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Accessing CANSIM NDM product 20-10-0001 from Statistics Canada</span></span>
<span><span class="co">#&gt; Parsing data to sqlite.</span></span>
<span><span class="co">#&gt; Indexing GEO</span></span>
<span><span class="co">#&gt; Indexing Vehicle type</span></span>
<span><span class="co">#&gt; Indexing Origin of manufacture</span></span>
<span><span class="co">#&gt; Indexing Sales</span></span>
<span><span class="co">#&gt; Indexing Seasonal adjustment</span></span>
<span><span class="co">#&gt; Indexing REF_DATE</span></span>
<span><span class="co">#&gt; Indexing DGUID</span></span>
<span><span class="co">#&gt; Indexing GeoUID</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">connection.sqlite</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: ??</span></span>
<span><span class="co">#&gt; Columns: 19</span></span>
<span><span class="co">#&gt; Database: sqlite 3.49.1 [/private/var/folders/z4/gcjq2cd93p3bs5bgp8j2vv240000gp/T/Rtmp7wg5g2/cansim_20100001_sqlite_eng/20100001-eng.sqlite]</span></span>
<span><span class="co">#&gt; $ REF_DATE                <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "1946-01"<span style="color: #949494;">, </span>"1946-01"<span style="color: #949494;">, </span>"1946-01"<span style="color: #949494;">, </span>"1946-01"<span style="color: #949494;">, </span>"1…</span></span>
<span><span class="co">#&gt; $ GEO                     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Canada"<span style="color: #949494;">, </span>"Canada"<span style="color: #949494;">, </span>"Canada"<span style="color: #949494;">, </span>"Canada"<span style="color: #949494;">, </span>"Canad…</span></span>
<span><span class="co">#&gt; $ GeoUID                  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "11124"<span style="color: #949494;">, </span>"11124"<span style="color: #949494;">, </span>"11124"<span style="color: #949494;">, </span>"11124"<span style="color: #949494;">, </span>"11124"<span style="color: #949494;">, </span>"…</span></span>
<span><span class="co">#&gt; $ DGUID                   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "2016A000011124"<span style="color: #949494;">, </span>"2016A000011124"<span style="color: #949494;">, </span>"2016A0000…</span></span>
<span><span class="co">#&gt; $ `Vehicle type`          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Total, new motor vehicles"<span style="color: #949494;">, </span>"Total, new motor…</span></span>
<span><span class="co">#&gt; $ `Origin of manufacture` <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Total, country of manufacture"<span style="color: #949494;">, </span>"Total, count…</span></span>
<span><span class="co">#&gt; $ Sales                   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Units"<span style="color: #949494;">, </span>"Dollars"<span style="color: #949494;">, </span>"Units"<span style="color: #949494;">, </span>"Units"<span style="color: #949494;">, </span>"Dollars…</span></span>
<span><span class="co">#&gt; $ `Seasonal adjustment`   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Unadjusted"<span style="color: #949494;">, </span>"Unadjusted"<span style="color: #949494;">, </span>"Unadjusted"<span style="color: #949494;">, </span>"Sea…</span></span>
<span><span class="co">#&gt; $ UOM                     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Units"<span style="color: #949494;">, </span>"Dollars"<span style="color: #949494;">, </span>"Units"<span style="color: #949494;">, </span>"Units"<span style="color: #949494;">, </span>"Dollars…</span></span>
<span><span class="co">#&gt; $ UOM_ID                  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "300"<span style="color: #949494;">, </span>"81"<span style="color: #949494;">, </span>"300"<span style="color: #949494;">, </span>"300"<span style="color: #949494;">, </span>"81"<span style="color: #949494;">, </span>"300"<span style="color: #949494;">, </span>"300"<span style="color: #949494;">,</span>…</span></span>
<span><span class="co">#&gt; $ SCALAR_FACTOR           <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "units"<span style="color: #949494;">, </span>"thousands"<span style="color: #949494;">, </span>"units"<span style="color: #949494;">, </span>"units"<span style="color: #949494;">, </span>"thous…</span></span>
<span><span class="co">#&gt; $ SCALAR_ID               <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "0"<span style="color: #949494;">, </span>"3"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"3"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"3"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"…</span></span>
<span><span class="co">#&gt; $ VECTOR                  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "v42169911"<span style="color: #949494;">, </span>"v42169913"<span style="color: #949494;">, </span>"v42169920"<span style="color: #949494;">, </span>"v42169…</span></span>
<span><span class="co">#&gt; $ COORDINATE              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "1.1.1.1.1"<span style="color: #949494;">, </span>"1.1.1.2.1"<span style="color: #949494;">, </span>"1.2.1.1.1"<span style="color: #949494;">, </span>"1.2.1.…</span></span>
<span><span class="co">#&gt; $ VALUE                   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2756<span style="color: #949494;">, </span>4507<span style="color: #949494;">, </span>1102<span style="color: #949494;">, </span>1468<span style="color: #949494;">, </span>1604<span style="color: #949494;">, </span>1654<span style="color: #949494;">, </span>2037<span style="color: #949494;">, </span>2903…</span></span>
<span><span class="co">#&gt; $ STATUS                  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span>…</span></span>
<span><span class="co">#&gt; $ SYMBOL                  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span>…</span></span>
<span><span class="co">#&gt; $ TERMINATED              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span>"t"<span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span>"t"<span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span>…</span></span>
<span><span class="co">#&gt; $ DECIMALS                <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "0"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"0"<span style="color: #949494;">, </span>"…</span></span></code></pre></div>
</div>
<p>To make good use of the data we will have to look at the metadata and
inspect the member columns and variables available.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_cansim_table_overview.html">get_cansim_table_overview</a></span><span class="op">(</span><span class="st">"20-10-0001"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading CANSIM NDM product 20-10-0001 information from cache.</span></span>
<span><span class="co">#&gt; 20100001</span></span>
<span><span class="co">#&gt; CANSIM Table 20-10-0001</span></span>
<span><span class="co">#&gt; Start Reference Period: 2024-12-01, End Reference Period: 5, Frequency: 1946-01-01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Column Geography (11)</span></span>
<span><span class="co">#&gt; Newfoundland and Labrador, Prince Edward Island, Nova Scotia, New Brunswick, Quebec, Ontario, Manitoba, Saskatchewan, Alberta, British Columbia and the Territories, ...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Column Vehicle type (3)</span></span>
<span><span class="co">#&gt; Passenger cars, Trucks, Total, new motor vehicles</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Column Origin of manufacture (5)</span></span>
<span><span class="co">#&gt; North America, Total, overseas, Japan, Other countries, Total, country of manufacture</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Column Sales (2)</span></span>
<span><span class="co">#&gt; Units, Dollars</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Column Seasonal adjustment (2)</span></span>
<span><span class="co">#&gt; Unadjusted, Seasonally adjusted</span></span></code></pre></div>
<p>This gives us an understanding of the available variables. For the
purpose of this vignette we are interested in the breakdown of sales
units by Vehicle type in Canada overall. The data is stored in its raw
form in the database, the only processing done is that it is augmented
by the GeoUID.</p>
</div>
<div class="section level2 tabset tabset-pills">
<h2 class="tabset tabset-pills" id="filtering-and-loading-into-memory">Filtering and loading into memory<a class="anchor" aria-label="anchor" href="#filtering-and-loading-into-memory"></a>
</h2>
<p>In order to work with the data we need to load it into memory, which
is done calling <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> on the connection object. If we
want to make use of the additional metadata and processing the
<em>cansim</em> package usually does and the main operations done on the
connection were filtering (and not renaming or de-selecing columns
needed for enriching with metadata) then we can utilize the custom
<code>collect_and_normalize</code> function to do this and at the same
time normalize the data so it will appear the same way as if we had used
the <code>get_cansim</code> function. This will add the category and
hierarchy metadata and the normalized value column. In the case of
<em>sqlite</em> connections we might want to pass the
<code>disconnect = TRUE</code> argument in the
<code>collect_and_normalize</code> function to close the connection
after normalizing the data, or do that manually at a later time via
<code>disconnect_cansim_sqlite(connection)</code>. This is not required
for <em>parquet</em> or <em>feather</em> connections.</p>
<p>The <code><a href="../reference/collect_and_normalize.html">collect_and_normalize()</a></code> interface is designed to be
used in the same way across database formats. In this comparison we also
add the “traditional” <code><a href="../reference/get_cansim.html">get_cansim()</a></code> approach that reads the
entire table into memory and normalizes the data.</p>
<div class="section level3 active">
<h3 class="active" id="parquet-1">parquet<a class="anchor" aria-label="anchor" href="#parquet-1"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data.parquet</span> <span class="op">&lt;-</span> <span class="va">connection.parquet</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">GEO</span><span class="op">==</span><span class="st">"Canada"</span>,</span>
<span>         <span class="va">`Seasonal adjustment`</span><span class="op">==</span><span class="st">"Unadjusted"</span>,</span>
<span>         <span class="va">Sales</span><span class="op">==</span><span class="st">"Units"</span>,</span>
<span>         <span class="va">`Origin of manufacture`</span><span class="op">==</span><span class="st">"Total, country of manufacture"</span>,</span>
<span>         <span class="va">`Vehicle type`</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Passenger cars"</span>,<span class="st">"Trucks"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/collect_and_normalize.html">collect_and_normalize</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data.parquet</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 30</span></span></span>
<span><span class="co">#&gt;   REF_DATE Date       GEO    DGUID  GeoUID `Vehicle type` Origin of manufactur…¹</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>                 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 1946-01  1946-01-01 Canada 2016A… 11124  Passenger cars Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 1946-01  1946-01-01 Canada 2016A… 11124  Trucks         Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 1946-02  1946-02-01 Canada 2016A… 11124  Passenger cars Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 1946-02  1946-02-01 Canada 2016A… 11124  Trucks         Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 1946-03  1946-03-01 Canada 2016A… 11124  Passenger cars Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 1946-03  1946-03-01 Canada 2016A… 11124  Trucks         Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ abbreviated name: ¹​`Origin of manufacture`</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 23 more variables: Sales &lt;fct&gt;, `Seasonal adjustment` &lt;fct&gt;, VALUE &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   val_norm &lt;dbl&gt;, UOM &lt;chr&gt;, UOM_ID &lt;chr&gt;, SCALAR_FACTOR &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   SCALAR_ID &lt;chr&gt;, VECTOR &lt;chr&gt;, COORDINATE &lt;chr&gt;, STATUS &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   SYMBOL &lt;chr&gt;, TERMINATED &lt;chr&gt;, DECIMALS &lt;chr&gt;, `Hierarchy for GEO` &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   `Classification Code for Vehicle type` &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   `Hierarchy for Vehicle type` &lt;chr&gt;, …</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="feather-1">feather<a class="anchor" aria-label="anchor" href="#feather-1"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data.feather</span> <span class="op">&lt;-</span> <span class="va">connection.feather</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">GEO</span><span class="op">==</span><span class="st">"Canada"</span>,</span>
<span>         <span class="va">`Seasonal adjustment`</span><span class="op">==</span><span class="st">"Unadjusted"</span>,</span>
<span>         <span class="va">Sales</span><span class="op">==</span><span class="st">"Units"</span>,</span>
<span>         <span class="va">`Origin of manufacture`</span><span class="op">==</span><span class="st">"Total, country of manufacture"</span>,</span>
<span>         <span class="va">`Vehicle type`</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Passenger cars"</span>,<span class="st">"Trucks"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/collect_and_normalize.html">collect_and_normalize</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data.feather</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 30</span></span></span>
<span><span class="co">#&gt;   REF_DATE Date       GEO    DGUID  GeoUID `Vehicle type` Origin of manufactur…¹</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>                 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 1946-01  1946-01-01 Canada 2016A… 11124  Passenger cars Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 1946-01  1946-01-01 Canada 2016A… 11124  Trucks         Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 1946-02  1946-02-01 Canada 2016A… 11124  Passenger cars Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 1946-02  1946-02-01 Canada 2016A… 11124  Trucks         Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 1946-03  1946-03-01 Canada 2016A… 11124  Passenger cars Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 1946-03  1946-03-01 Canada 2016A… 11124  Trucks         Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ abbreviated name: ¹​`Origin of manufacture`</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 23 more variables: Sales &lt;fct&gt;, `Seasonal adjustment` &lt;fct&gt;, VALUE &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   val_norm &lt;dbl&gt;, UOM &lt;chr&gt;, UOM_ID &lt;chr&gt;, SCALAR_FACTOR &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   SCALAR_ID &lt;chr&gt;, VECTOR &lt;chr&gt;, COORDINATE &lt;chr&gt;, STATUS &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   SYMBOL &lt;chr&gt;, TERMINATED &lt;chr&gt;, DECIMALS &lt;chr&gt;, `Hierarchy for GEO` &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   `Classification Code for Vehicle type` &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   `Hierarchy for Vehicle type` &lt;chr&gt;, …</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sqlite-1">sqlite<a class="anchor" aria-label="anchor" href="#sqlite-1"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data.sqlite</span> <span class="op">&lt;-</span> <span class="va">connection.sqlite</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">GEO</span><span class="op">==</span><span class="st">"Canada"</span>,</span>
<span>         <span class="va">`Seasonal adjustment`</span><span class="op">==</span><span class="st">"Unadjusted"</span>,</span>
<span>         <span class="va">Sales</span><span class="op">==</span><span class="st">"Units"</span>,</span>
<span>         <span class="va">`Origin of manufacture`</span><span class="op">==</span><span class="st">"Total, country of manufacture"</span>,</span>
<span>         <span class="va">`Vehicle type`</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Passenger cars"</span>,<span class="st">"Trucks"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/collect_and_normalize.html">collect_and_normalize</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data.sqlite</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 30</span></span></span>
<span><span class="co">#&gt;   REF_DATE Date       GEO    DGUID  GeoUID `Vehicle type` Origin of manufactur…¹</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>                 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 1946-01  1946-01-01 Canada 2016A… 11124  Passenger cars Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 1946-01  1946-01-01 Canada 2016A… 11124  Trucks         Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 1946-02  1946-02-01 Canada 2016A… 11124  Passenger cars Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 1946-02  1946-02-01 Canada 2016A… 11124  Trucks         Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 1946-03  1946-03-01 Canada 2016A… 11124  Passenger cars Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 1946-03  1946-03-01 Canada 2016A… 11124  Trucks         Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ abbreviated name: ¹​`Origin of manufacture`</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 23 more variables: Sales &lt;fct&gt;, `Seasonal adjustment` &lt;fct&gt;, VALUE &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   val_norm &lt;dbl&gt;, UOM &lt;chr&gt;, UOM_ID &lt;chr&gt;, SCALAR_FACTOR &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   SCALAR_ID &lt;chr&gt;, VECTOR &lt;chr&gt;, COORDINATE &lt;chr&gt;, STATUS &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   SYMBOL &lt;chr&gt;, TERMINATED &lt;chr&gt;, DECIMALS &lt;chr&gt;, `Hierarchy for GEO` &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   `Classification Code for Vehicle type` &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   `Hierarchy for Vehicle type` &lt;chr&gt;, …</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="traditional">traditional<a class="anchor" aria-label="anchor" href="#traditional"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data.memory</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_cansim.html">get_cansim</a></span><span class="op">(</span><span class="st">"20-10-0001"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">GEO</span><span class="op">==</span><span class="st">"Canada"</span>,</span>
<span>         <span class="va">`Seasonal adjustment`</span><span class="op">==</span><span class="st">"Unadjusted"</span>,</span>
<span>         <span class="va">Sales</span><span class="op">==</span><span class="st">"Units"</span>,</span>
<span>         <span class="va">`Origin of manufacture`</span><span class="op">==</span><span class="st">"Total, country of manufacture"</span>,</span>
<span>         <span class="va">`Vehicle type`</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Passenger cars"</span>,<span class="st">"Trucks"</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Accessing CANSIM NDM product 20-10-0001 from Statistics Canada</span></span>
<span><span class="co">#&gt; Parsing data</span></span>
<span></span>
<span><span class="va">data.memory</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 30</span></span></span>
<span><span class="co">#&gt;   REF_DATE Date       GEO    DGUID  GeoUID `Vehicle type` Origin of manufactur…¹</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>                 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 1946-01  1946-01-01 Canada 2016A… 11124  Passenger cars Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 1946-01  1946-01-01 Canada 2016A… 11124  Trucks         Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 1946-02  1946-02-01 Canada 2016A… 11124  Passenger cars Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 1946-02  1946-02-01 Canada 2016A… 11124  Trucks         Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 1946-03  1946-03-01 Canada 2016A… 11124  Passenger cars Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 1946-03  1946-03-01 Canada 2016A… 11124  Trucks         Total, country of man…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ abbreviated name: ¹​`Origin of manufacture`</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 23 more variables: Sales &lt;fct&gt;, `Seasonal adjustment` &lt;fct&gt;, VALUE &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   val_norm &lt;dbl&gt;, UOM &lt;chr&gt;, UOM_ID &lt;chr&gt;, SCALAR_FACTOR &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   SCALAR_ID &lt;chr&gt;, VECTOR &lt;chr&gt;, COORDINATE &lt;chr&gt;, STATUS &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   SYMBOL &lt;chr&gt;, TERMINATED &lt;chr&gt;, DECIMALS &lt;chr&gt;, `Hierarchy for GEO` &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   `Classification Code for Vehicle type` &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   `Hierarchy for Vehicle type` &lt;chr&gt;, …</span></span></span></code></pre></div>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="section"></h2>
<p>We note that the syntax, and the resulting data frames, are
identical.</p>
</div>
<div class="section level2">
<h2 id="working-with-the-data">Working with the data<a class="anchor" aria-label="anchor" href="#working-with-the-data"></a>
</h2>
<p>With all three data formats producing the same output we can now work
with the data as if it was fetched and subsequently filtered via
<code>get_cansim</code>.</p>
<p>Given the data we can further filter the date range and plot it.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data.parquet</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Date</span><span class="op">&gt;=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"1990-01-01"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Date</span>,y<span class="op">=</span><span class="va">val_norm</span>,color<span class="op">=</span><span class="va">`Vehicle type`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>span<span class="op">=</span><span class="fl">0.2</span>,method <span class="op">=</span> <span class="st">'loess'</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html" class="external-link">comma</a></span><span class="op">(</span><span class="va">d</span>,scale<span class="op">=</span><span class="fl">10</span><span class="op">^</span><span class="op">-</span><span class="fl">3</span>,suffix<span class="op">=</span><span class="st">"k"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Canada new motor vehicle sales"</span>,caption<span class="op">=</span><span class="st">"StatCan Table 20-10-0001"</span>,</span>
<span>       x<span class="op">=</span><span class="cn">NULL</span>,y<span class="op">=</span><span class="st">"Number of units"</span><span class="op">)</span></span></code></pre></div>
<p><img src="working_with_large_tables_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="partitioning">Partitioning<a class="anchor" aria-label="anchor" href="#partitioning"></a>
</h2>
<p>To improve read performance of <em>parquet</em> and <em>feather</em>
data one can specify a <code>partioning</code> argument when calling
<code>get_cansim_connection</code>. This will partition the data by the
specified columns. This can be useful when filtering by these columns as
it will only read the relevant partitions and greatly increase read
performance with a sight cost to size on disk. If for example a dataset
is mostly accessed by filtering on geographic regions, it migh be useful
to partition by <code>GeoUID</code>, or the <code>GEO</code> column if
querying data by name. More than one partitioning column can be
specified, but this is only helpful for very large datasets with a high
number of dimensions. A <em>parquet</em> dataset that is partitioned
with the subsequent queries in mind is often faster in data retrieval
than an index SQLite database. The <a href="https://arrow.apache.org/docs/r/" class="external-link"><em>arrow</em> package</a> has
more guidance on partitioning and the tradeoffs.</p>
<div class="section level3">
<h3 id="repartitioning">Repartitioning<a class="anchor" aria-label="anchor" href="#repartitioning"></a>
</h3>
<p>Partitioning happens on initial data import and changing the
<code>partitioning</code> parameter in subsequent calls to
<code><a href="../reference/get_cansim_connection.html">get_cansim_connection()</a></code> won’t have any effect, althoug a
warning will get issued if the specified partitioning is not empty and
differs from the initial paritioning. In some cases, for example when
doing lots of data queries on the dataset, it might make sense to
occasionally change the partitioning of the data in order to optimize
read performance. This can be done with the
<code><a href="../reference/cansim_repartition_cached_table.html">cansim_repartition_cached_table()</a></code> that takes a
<code>new_partitioning</code> argument. Repartitioning happnes fairly
fast, taking up to several seconds on fairly large tables where the
original CSV is several gigabytes in size.</p>
</div>
</div>
<div class="section level2">
<h2 id="keeping-track-of-cached-data">Keeping track of cached data<a class="anchor" aria-label="anchor" href="#keeping-track-of-cached-data"></a>
</h2>
<p>Since we now have the option of a more permanent cache we should take
care to manage that space properly. The
<code>list_cansim_sqlite_cached_tables</code> function gives us an
overview over the cached data we have.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/list_cansim_cached_tables.html">list_cansim_cached_tables</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 10</span></span></span>
<span><span class="co">#&gt;   cansimTableNumber language dataFormat timeCached          niceSize  rawSize</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 20-10-0001        eng      feather    2025-05-08 <span style="color: #949494;">21:33:04</span> 10.5 Mb  11<span style="text-decoration: underline;">021</span>778</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 20-10-0001        eng      parquet    2025-05-08 <span style="color: #949494;">21:32:59</span> 1.1 Mb    1<span style="text-decoration: underline;">133</span>941</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 20-10-0001        eng      sqlite     2025-05-08 <span style="color: #949494;">21:33:07</span> 47.1 Mb  49<span style="text-decoration: underline;">410</span>048</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4 more variables: title &lt;chr&gt;, path &lt;chr&gt;, timeReleased &lt;dttm&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   upToDate &lt;lgl&gt;</span></span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="removing-cached-data">Removing cached data<a class="anchor" aria-label="anchor" href="#removing-cached-data"></a>
</h2>
<p>If we want to free up disk space we can remove a cached table or
several tables. The following call will remove all cached “20-10-0001”
tables in all formats and languages. Before that we disconnect the
connection to the <em>sqlite</em> database.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/disconnect_cansim_sqlite.html">disconnect_cansim_sqlite</a></span><span class="op">(</span><span class="va">connection.sqlite</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/remove_cansim_cached_tables.html">remove_cansim_cached_tables</a></span><span class="op">(</span><span class="st">"20-10-0001"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Removing feather cached data for 20-10-0001 (eng)</span></span>
<span><span class="co">#&gt; Removing parquet cached data for 20-10-0001 (eng)</span></span>
<span><span class="co">#&gt; Removing sqlite cached data for 20-10-0001 (eng)</span></span></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://mountainmath.ca" class="external-link">Jens von Bergmann</a>, <a href="https://dshkol.com" class="external-link">Dmitry Shkolnik</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

      </footer>
</body>
</html>
