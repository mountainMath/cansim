<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-CA">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with Statistics Canada data table object hierarchies • cansim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Working with Statistics Canada data table object hierarchies">
<meta name="description" content="Statistics Canada data tables comes with rich metadata, including on the hierarchy of categories in each dimension. The packages incorporates this metadata and allows for selecting data by hierarchy level.
">
<meta property="og:description" content="Statistics Canada data tables comes with rich metadata, including on the hierarchy of categories in each dimension. The packages incorporates this metadata and allows for selecting data by hierarchy level.
">
<meta property="og:image" content="https://mountainmath.github.io/cansim/logo.png">
<meta property="og:image:alt" content="cansim">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@vb_jens">
<meta name="twitter:site" content="https://mountainmath.github.io/cansim/">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-107390160-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-107390160-2');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cansim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/cansim.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/listing_cansim_tables.html">Listing Statistics Canada data tables</a></li>
    <li><a class="dropdown-item" href="../articles/partial_table_data_download.html">Partial table data download</a></li>
    <li><a class="dropdown-item" href="../articles/retrieving_cansim_vectors.html">Retrieving individual Statistics Canada vectors</a></li>
    <li><a class="dropdown-item" href="../articles/working_with_hierarchies.html">Working with Statistics Canada data table object hierarchies</a></li>
    <li><a class="dropdown-item" href="../articles/working_with_large_tables.html">Working with large tables</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://github.com/mountainMath/cansim/releases/tag/v0.3.8">Version 0.3.8</a></li>
    <li><a class="external-link dropdown-item" href="https://github.com/mountainMath/cansim/releases/tag/v0.3.7">Version 0.3.7</a></li>
    <li><a class="external-link dropdown-item" href="https://github.com/mountainMath/cansim/releases/tag/0.3.6">Version 0.3.6</a></li>
    <li><a class="external-link dropdown-item" href="https://github.com/mountainMath/cansim/releases/tag/0.3.5">Version 0.3.5</a></li>
    <li><a class="external-link dropdown-item" href="https://github.com/mountainMath/cansim/releases/tag/0.3.4">Version 0.3.4</a></li>
    <li><a class="external-link dropdown-item" href="https://github.com/mountainMath/cansim/releases/tag/0.3.2">Version 0.3.2</a></li>
    <li><a class="external-link dropdown-item" href="https://github.com/mountainMath/cansim/releases/tag/0.3.1">Version 0.3.1</a></li>
    <li><a class="external-link dropdown-item" href="https://github.com/mountainMath/cansim/releases/tag/0.3">Version 0.3</a></li>
    <li><a class="external-link dropdown-item" href="https://github.com/mountainMath/cansim/releases/tag/0.2.2">Version 0.2.2</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mountainMath/cansim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Working with Statistics Canada data table object hierarchies</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mountainMath/cansim/blob/HEAD/vignettes/working_with_hierarchies.Rmd" class="external-link"><code>vignettes/working_with_hierarchies.Rmd</code></a></small>
      <div class="d-none name"><code>working_with_hierarchies.Rmd</code></div>
    </div>

    
    
<p>This vignette showcases how to utilize the metadata information by
drilling into North American Industry Classification System (NAICS)
categories and the hierarchy metadata that is downloaded with tables
that have hierarchical data.</p>
<div class="section level3">
<h3 id="retrieving-metadata">Retrieving metadata<a class="anchor" aria-label="anchor" href="#retrieving-metadata"></a>
</h3>
<p>The <code>get_cansim_table_overview</code> function displays an
overview of table information. If the table is not yet downloaded and
cached it will first download the table itself. Let’s take a look what’s
in the table we are interested in.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mountainMath/cansim" class="external-link">cansim</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># select a table number</span></span>
<span><span class="va">table_id</span> <span class="op">=</span> <span class="st">"36-10-0402"</span></span>
<span></span>
<span><span class="co"># get table overview</span></span>
<span><span class="fu"><a href="../reference/get_cansim_table_overview.html">get_cansim_table_overview</a></span><span class="op">(</span><span class="va">table_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; Gross domestic product (GDP) at basic prices, by industry, provinces and territories</span></span>
<span><span class="co">#&gt; CANSIM Table 36-10-0402</span></span>
<span><span class="co">#&gt; Start Reference Period: 1997-01-01, End Reference Period: 2024-01-01, Frequency: 12</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Column Geography (13)</span></span>
<span><span class="co">#&gt; Newfoundland and Labrador, Prince Edward Island, Nova Scotia, New Brunswick, Quebec, Ontario, Manitoba, Saskatchewan, Alberta, British Columbia, ...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Column Prices (3)</span></span>
<span><span class="co">#&gt; Current dollars, Chained (2017) dollars, Contributions to percent change</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Column North American Industry Classification System (NAICS) (337)</span></span>
<span><span class="co">#&gt; All industries, Goods-producing industries, Service-producing industries, Industrial production, Non-durable manufacturing industries, Durable manufacturing industries, Information and communication technology sector, Information and communication technology, manufacturing, Information and communication technology, services, Energy sector, ...</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="accessing-table-data">Accessing table data<a class="anchor" aria-label="anchor" href="#accessing-table-data"></a>
</h3>
<p>We see that data set come with three different measures and 307
different NAICS values. Let’s load the data and focus on just “Chained
(2017) dollars”.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_cansim.html">get_cansim</a></span><span class="op">(</span><span class="va">table_id</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Reading CANSIM NDM product 36-10-0402 from cache.</span></span>
<span></span>
<span><span class="va">selected_value</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Prices</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"Chained"</span>,<span class="va">data</span><span class="op">$</span><span class="va">Prices</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Prices</span> <span class="op">==</span> <span class="va">selected_value</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="taking-advantage-of-metadata">Taking advantage of metadata<a class="anchor" aria-label="anchor" href="#taking-advantage-of-metadata"></a>
</h3>
<p>This table includes all the different levels of NAICS categories in
one dimension. This makes working with the data at that level rather
cumbersome when we are often only interested in specific sub-categories.
The internal hierarchy can help with that. Let’s first get an overview
of the data. We can also use this to easily compute shares instead of
totals.</p>
<p>We can extract the hierarchy using the built-in convenience function
<code>categories_for_level</code> which takes in a
<code>cansim</code>-package retrieved data table object with metadata as
input and requires a field from which to extract categories from as well
as a level indicating the target depth level of the hierarchy that we
wish to extract.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract top-level hierarchy to calculate total</span></span>
<span><span class="va">top_level</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/categories_for_level.html">categories_for_level</a></span><span class="op">(</span><span class="va">data</span>, <span class="st">"North American Industry Classification System (NAICS)"</span>,<span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract total using hierarchy and calculate share by NAICS. </span></span>
<span><span class="co"># This could also be done using grouping functions from dplyr, </span></span>
<span><span class="co"># but we wanted to demonstrate how to use specific hierarchy levels. </span></span>
<span><span class="va">total_data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">`North American Industry Classification System (NAICS)`</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">top_level</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Total <span class="op">=</span> <span class="va">val_norm</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Date</span>, <span class="va">GEO</span>, <span class="va">Total</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge total back in and calculate share for every NAICS code</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">total_data</span>,by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Date"</span>, <span class="st">"GEO"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Share <span class="op">=</span> <span class="va">val_norm</span><span class="op">/</span><span class="va">Total</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="hierarchies-in-more-detail">Hierarchies in more detail<a class="anchor" aria-label="anchor" href="#hierarchies-in-more-detail"></a>
</h3>
<p>There are hundreds of NAICS codes here which is too many to make
sense of at the same time. We can use <code>categories_for_level</code>
again to reduce our NAICS codes just to the first sub-level which
represents the industry groups. We can call this subset
<code>cut_data</code>. (Note that the NAICS data also includes composite
groups of industries, something like a level 0.5 hierarchy, which are
prefixed with a “T” and which we want to remove as well.)</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cut_data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"T\\d+"</span>,<span class="va">`Classification Code for North American Industry Classification System (NAICS)`</span><span class="op">)</span>,</span>
<span>  <span class="va">`North American Industry Classification System (NAICS)`</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> </span>
<span>    <span class="fu"><a href="../reference/categories_for_level.html">categories_for_level</a></span><span class="op">(</span><span class="va">.</span>,<span class="st">"North American Industry Classification System (NAICS)"</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># How many are NAICS categories left? </span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cut_data</span><span class="op">$</span><span class="va">`North American Industry Classification System (NAICS)`</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unique</span><span class="op">)</span></span></code></pre></div>
<p>There are still 22 level 1 categories, too many to sensibly visualize
at the same time. We can use <code>dplyr</code> functions to identify
the top categories and group the rest so that we can have a plot that is
easier to understand.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Specify which regions and period we want to look at </span></span>
<span><span class="va">regions</span> <span class="op">=</span> <span class="st">"British Columbia"</span></span>
<span><span class="va">period</span> <span class="op">=</span> <span class="st">"2019-07-01"</span></span>
<span></span>
<span><span class="co"># Select the top-8 categories for our reference region and period</span></span>
<span><span class="va">top_categories</span> <span class="op">&lt;-</span> <span class="va">cut_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">GEO</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">regions</span>, <span class="va">Date</span> <span class="op">==</span> <span class="va">period</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html" class="external-link">top_n</a></span><span class="op">(</span><span class="fl">8</span>,<span class="va">Share</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="st">"North American Industry Classification System (NAICS)"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Group remaining categories together and prepare data for plot</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">cut_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>NAICS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">`North American Industry Classification System (NAICS)`</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">top_categories</span>,<span class="va">`North American Industry Classification System (NAICS)`</span>,<span class="st">"Rest"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Date</span>, <span class="va">GEO</span>, <span class="va">NAICS</span>, <span class="va">VALUE</span>, <span class="va">Share</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Date</span>, <span class="va">GEO</span>, <span class="va">NAICS</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>VALUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">VALUE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            Share <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Share</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> </span></code></pre></div>
<p>With the data prepared, the last step is putting it all together into
a visualization using <code>ggplot2</code>. We can then see if any
further adjustments are required.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">GEO</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">regions</span><span class="op">)</span>, </span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Date</span>, y <span class="op">=</span> <span class="va">Share</span>, fill <span class="op">=</span> <span class="va">NAICS</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_area</a></span><span class="op">(</span>position<span class="op">=</span><span class="st">"stack"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,legend.direction <span class="op">=</span><span class="st">"vertical"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Gross domestic product (GDP) at basic prices"</span>,</span>
<span>       subtitle<span class="op">=</span><span class="va">selected_value</span>,</span>
<span>       x<span class="op">=</span><span class="st">""</span>, fill <span class="op">=</span> <span class="st">""</span>, </span>
<span>       caption<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"CANSIM "</span>, <span class="va">table_id</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="working_with_hierarchies_files/figure-html/unnamed-chunk-6-1.png" alt="Vignette example plot, GDP by NAICS" width="864">
Let’s have a closer look at the “Real estate and rental and leasing” and
“Construction” categories. Once again we turn to the
<code>categories_for_level</code> function to make grabbing the
sub-categories an easier process.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">real_construction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Construction [23]"</span>,<span class="st">"Real estate and rental and leasing [53]"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the NAICS hierarchy codes just for these categories</span></span>
<span><span class="va">rrl_hierarchy</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">`North American Industry Classification System (NAICS)`</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">real_construction</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="st">"Hierarchy for North American Industry Classification System (NAICS)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="va">unique</span></span>
<span></span>
<span><span class="co"># Filter out all sub-categories for Real Estate. </span></span>
<span><span class="co"># The paste with | trick ensures that we grepl for all matches. </span></span>
<span><span class="va">rrl_data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">rrl_hierarchy</span>,collapse<span class="op">=</span><span class="st">"|"</span><span class="op">)</span>,<span class="va">`Hierarchy for North American Industry Classification System (NAICS)`</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Ensure we only retain the NAICS leaves and none of the aggregate subcategories</span></span>
<span><span class="va">rrl_data</span> <span class="op">&lt;-</span> <span class="va">rrl_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>  <span class="va">`North American Industry Classification System (NAICS)`</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> </span>
<span>    <span class="fu"><a href="../reference/categories_for_level.html">categories_for_level</a></span><span class="op">(</span><span class="va">.</span>,<span class="st">"North American Industry Classification System (NAICS)"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>NAICS<span class="op">=</span><span class="va">`North American Industry Classification System (NAICS)`</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot with labels from our original selections</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rrl_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">GEO</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">regions</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Date</span>, y <span class="op">=</span> <span class="va">Share</span>, fill <span class="op">=</span> <span class="va">NAICS</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_area</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"stack"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,legend.direction <span class="op">=</span><span class="st">"vertical"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Gross domestic product (GDP) at basic prices"</span>,</span>
<span>       subtitle<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">regions</span>,<span class="st">", "</span>, <span class="va">selected_value</span><span class="op">)</span>,</span>
<span>       x<span class="op">=</span><span class="st">""</span>,</span>
<span>       caption<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"CANSIM "</span>, <span class="va">table_id</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="working_with_hierarchies_files/figure-html/unnamed-chunk-7-1.png" alt="Vignette example plot, GDP by NAICS" width="864">
We observe in the resulting chart that the largest contributors to GDP
in this sector in British Columbia are Owner-occupied dwellings (imputed
rent) and Lessors of Real estate (rent), followed by Residential
building construction.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://mountainmath.ca" class="external-link">Jens von Bergmann</a>, <a href="https://dshkol.com" class="external-link">Dmitry Shkolnik</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
